#/bin/bash

###
# Description: Custom postscript for xcat.
#              Re-install kerberos keytab (if preciously backed up)
# Source: https://github.com/ncsa/xcat-tools
###

#
# PREP
#
PRG=$( basename $0 )
logger -t xcat -p local4.info "running '$PRG' on node $NODE"


#
# DEFAULT SETTINGS
#
KEYTABDIR=/etc
BKUP_KEYTABDIR=/install/files/compute/var/lib/kerberos/keytab


#
# FUNCTIONS
#
logr() {
  logger -t xcat -p local4.info "$*"
  echo "$*"
}


croak() {
  logr "ERROR - $*"
  echo "ERROR - $*"
  exit 99
}


#
# DO WORK
#
logr "ensure $MASTER:$INSTALLDIR is mounted"
/xcatpost/mountinstall || exit 2
#ls -R /install

logr "copying kerberos keytab from the master."
set -x
if [[ -f $BKUP_KEYTABDIR/${NODE}.krb5.keytab ]]; then
  cp $BKUP_KEYTABDIR/${NODE}.krb5.keytab $KEYTABDIR/krb5.keytab
  chmod 600 $KEYTABDIR/krb5.keytab
  chown root.root $KEYTABDIR/krb5.keytab
fi

ls -R $KEYTABDIR/krb5.keytab
strings $KEYTABDIR/krb5.keytab | grep -i '${NODE}'
set +x


logr "end of kerberos_keytab on OS $os on node $NODE"

exit 0
